<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Command Center</title>
    <style>
        :root {
            --bg: #050505; --surface: #111; --accent: #00f2ff;
            --success: #00ff88; --text: #fff; --text-dim: #666; --danger: #ff4444;
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: 'Inter', system-ui, sans-serif; margin: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-x: hidden;
        }

        /* --- PULSE BAR (QUOTES) --- */
        #pulse-bar {
            width: 100%; background: #000; padding: 12px 0;
            border-bottom: 1px solid #222; display: flex;
            justify-content: center;
            font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 2px; color: var(--accent);
            text-align: center;
        }

        /* --- LOCK SCREEN --- */
        #lock-screen {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        #pin-input {
            background: #000; border: 2px solid var(--accent); color: var(--accent);
            font-size: 3rem; width: 180px; text-align: center; border-radius: 12px;
        }

        /* --- MAIN UI --- */
        #main-ui { display: none; width: 95%; max-width: 800px; padding: 30px; flex-direction: column; }
        
        /* HEADER */
        .header-flex { display: flex; justify-content: center; align-items: flex-end; margin-bottom: 40px; }
        .date-nav { display: flex; align-items: center; gap: 20px; }
        .nav-arrow {
            background: transparent; border: 1px solid #333; color: var(--accent);
            font-size: 1.5rem; cursor: pointer; padding: 10px 15px; border-radius: 8px;
            transition: 0.2s; user-select: none;
        }
        .nav-arrow:hover { background: var(--accent); color: #000; }
        
        .date-wrapper { text-align: center; }
        #date-header { font-size: 4rem; font-weight: 900; margin: 0; letter-spacing: -3px; line-height: 1; }
        #day-header { color: var(--accent); margin:0; letter-spacing:3px; font-size: 1.2rem; }

        /* --- HABITS --- */
        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        
        .card {
            background: var(--surface); padding: 20px 25px; border-radius: 15px; border: 1px solid #222;
            cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: space-between;
        }
        .card:focus, .card:hover { border-color: var(--accent); outline: none; background: #1a1a1a; transform: translateY(-3px); }
        .card.done { border-color: var(--success); }
        .card.done .check { color: var(--success); text-shadow: 0 0 10px var(--success); }

        /* Main Screen Delete Button */
        .delete-btn {
            background: transparent; border: none; color: #333; font-size: 1.5rem;
            cursor: pointer; padding: 0 0 0 15px; line-height: 1; transition: 0.2s;
        }
        .delete-btn:hover { color: var(--danger); transform: scale(1.1); }

        /* --- MODAL --- */
        #modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: none; justify-content: center; align-items: center; z-index: 5000;
        }
        .modal-content {
            background: var(--surface); width: 90%; max-width: 1000px; padding: 40px; border-radius: 20px;
            display: flex; gap: 30px; border: 1px solid #333; height: 500px;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; flex: 2; overflow-y: auto; }
        .day-cell { aspect-ratio: 1; background: #000; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; border: 1px solid #222; }
        .day-cell.perfect { background: var(--success) !important; color: #000; font-weight: bold; }
        .day-cell:hover, .day-cell.selected { border-color: var(--accent); background: #222; }
        
        .details-pane { flex: 1; background: #050505; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; }
        
        /* History List Styles */
        #det-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .hist-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 0; border-bottom: 1px solid #222; font-size: 0.9rem; 
        }
        .hist-del-btn {
            background: none; border: none; color: #444; cursor: pointer; font-size: 1.2rem;
        }
        .hist-del-btn:hover { color: var(--danger); }

        .btn {
            background: #222; color: #fff; padding: 12px 24px; border-radius: 8px;
            border: 1px solid #333; cursor: pointer; font-weight: bold; margin-top: 20px;
        }
        .btn:focus { background: var(--accent); color: #000; outline: none; }
        
        .controls { display:flex; gap:10px; justify-content: center; margin-top: 40px;}
    </style>
</head>
<body>

    <div id="pulse-bar">
        <span id="daily-quote"></span>
    </div>

    <div id="lock-screen">
        <input type="password" id="pin-input" maxlength="4" placeholder="PIN" autofocus>
    </div>

    <div id="main-ui">
        <div class="header-flex">
            <div class="date-nav">
                <button class="nav-arrow" onclick="changeDate(-1)">&#9664;</button>
                <div class="date-wrapper">
                    <p id="day-header"></p>
                    <h1 id="date-header"></h1>
                </div>
                <button class="nav-arrow" onclick="changeDate(1)">&#9654;</button>
            </div>
        </div>

        <div class="grid" id="habit-grid"></div>

        <div class="controls">
            <button class="btn" onclick="toggleModal(true)">MONTHLY OVERVIEW</button>
            <button class="btn" onclick="addHabit()">+ HABIT</button>
            <button class="btn" onclick="resetDay()">RESET PROGRESS</button>
        </div>
    </div>

    <div id="modal" onclick="toggleModal(false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="calendar-grid" id="calendar"></div>
            <div class="details-pane">
                <h3 id="det-date" style="color: var(--accent)">Select Day</h3>
                <ul id="det-list"></ul>
            </div>
        </div>
    </div>

    <script>
        const PIN = "8472";
        
        const QUOTES = [
            "We are what we repeatedly do. Excellence, then, is not an act, but a habit.",
            "The pain of discipline or the pain of regret"
        ];
        
        let habits = JSON.parse(localStorage.getItem('h-v5')) || [];
        let history = JSON.parse(localStorage.getItem('hist-v5')) || {};
        let viewOffset = 0; 
        let selectedHistoryDate = null; // Track selected date in modal

        document.getElementById('pin-input').addEventListener('input', (e) => {
            if(e.target.value === PIN) {
                document.getElementById('lock-screen').style.display='none';
                document.getElementById('main-ui').style.display='flex';
                init();
            }
        });

        function init() {
            updateQuote();
            checkDayReset();
            render();
        }

        function updateQuote() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);
            const quoteIndex = dayOfYear % QUOTES.length;
            document.getElementById('daily-quote').innerText = QUOTES[quoteIndex].toUpperCase();
        }

        function getViewDate() {
            const d = new Date();
            d.setDate(d.getDate() + viewOffset);
            return d;
        }
        
        function getDateString(dateObj) {
            return dateObj.toISOString().split('T')[0];
        }

        function changeDate(dir) {
            viewOffset += dir;
            render();
        }

        function render() {
            const grid = document.getElementById('habit-grid');
            grid.innerHTML = '';
            
            const viewDate = getViewDate();
            const viewDateStr = getDateString(viewDate);
            const isToday = viewOffset === 0;

            document.getElementById('date-header').innerText = viewDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            document.getElementById('day-header').innerText = viewDate.toLocaleDateString(undefined, { weekday: 'long' }) + (viewOffset === 0 ? " (Today)" : "");

            habits.forEach((h, index) => {
                let isDone = false;
                if (isToday) {
                    isDone = h.done;
                } else {
                    const record = history[viewDateStr];
                    if (record && record.items.includes(h.name)) isDone = true;
                }

                const card = document.createElement('div');
                card.className = `card ${isDone ? 'done' : ''}`;
                card.tabIndex = 0;
                
                card.innerHTML = `
                    <div style="flex-grow:1">${h.name}</div>
                    <div style="display:flex; align-items:center;">
                        <div class="check">${isDone ? '✦' : '✧'}</div>
                    </div>
                `;

                const delBtn = document.createElement('button');
                delBtn.innerHTML = '&times;';
                delBtn.className = 'delete-btn';
                delBtn.title = "Delete Habit";
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteHabit(index);
                };

                card.querySelector('div:last-child').appendChild(delBtn);

                card.onclick = () => toggleHabit(index, h.name, viewDateStr);
                card.onkeydown = (e) => { if(e.key === 'Enter') toggleHabit(index, h.name, viewDateStr); };
                
                grid.appendChild(card);
            });
        }

        function toggleHabit(index, name, dateStr) {
            const isToday = (dateStr === getDateString(new Date()));

            if (isToday) {
                habits[index].done = !habits[index].done;
                localStorage.setItem('h-v5', JSON.stringify(habits));
            }

            if (!history[dateStr]) history[dateStr] = { score: 0, items: [] };
            
            const histItems = history[dateStr].items;
            const itemIndex = histItems.indexOf(name);

            if (itemIndex > -1) histItems.splice(itemIndex, 1);
            else histItems.push(name);

            // Update score
            history[dateStr].score = habits.length ? histItems.length / habits.length : 0;
            localStorage.setItem('hist-v5', JSON.stringify(history));

            render();
        }

        function deleteHabit(index) {
            if(confirm("Are you sure you want to permanently delete this habit from your main list?")) {
                habits.splice(index, 1);
                save();
                render();
            }
        }

        function save() {
            localStorage.setItem('h-v5', JSON.stringify(habits));
            const todayStr = getDateString(new Date());
            history[todayStr] = { 
                score: habits.length ? habits.filter(x=>x.done).length / habits.length : 0,
                items: habits.filter(x=>x.done).map(x=>x.name)
            };
            localStorage.setItem('hist-v5', JSON.stringify(history));
        }

        function toggleModal(s) {
            document.getElementById('modal').style.display = s ? 'flex' : 'none';
            if(s) renderCalendar();
        }

        function renderCalendar() {
            const cal = document.getElementById('calendar'); cal.innerHTML = '';
            const now = new Date();
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            
            for(let d=1; d<=daysInMonth; d++) {
                const ds = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const data = history[ds];
                const cell = document.createElement('div');
                cell.className = 'day-cell' + (data?.score >= 1 ? ' perfect' : '');
                if (selectedHistoryDate === ds) cell.classList.add('selected');
                
                cell.innerText = d;
                
                // Click to view details
                cell.onclick = () => showHistoryDetails(ds, d);
                
                cal.appendChild(cell);
            }
        }

        function showHistoryDetails(dateStr, dayNum) {
            selectedHistoryDate = dateStr;
            renderCalendar(); // Re-render to show selected state
            
            const data = history[dateStr];
            document.getElementById('det-date').innerText = `Details for Day ${dayNum}`;
            const list = document.getElementById('det-list');
            list.innerHTML = '';

            if (data && data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'hist-item';
                    li.innerHTML = `
                        <span>${item}</span>
                        <button class="hist-del-btn" onclick="removeHistoryItem('${dateStr}', '${item}')">&times;</button>
                    `;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = '<div style="color:#666; font-style:italic;">No habits recorded.</div>';
            }
        }

        function removeHistoryItem(dateStr, itemName) {
            if(!confirm(`Remove "${itemName}" from history for this date?`)) return;

            const rec = history[dateStr];
            if(rec) {
                // Filter out the item
                rec.items = rec.items.filter(x => x !== itemName);
                
                // Update score (approximate based on current habit count to keep consistent)
                rec.score = habits.length > 0 ? rec.items.length / habits.length : 0;
                
                localStorage.setItem('hist-v5', JSON.stringify(history));
                
                // Refresh views
                showHistoryDetails(dateStr, parseInt(dateStr.split('-')[2]));
                renderCalendar();
                render(); // In case we are currently viewing this day in the background
            }
        }

        function addHabit() { 
            const n = prompt("New Habit:"); 
            if(n) { habits.push({name:n, done:false}); save(); render(); } 
        }
        
        function checkDayReset() {
            const t = getDateString(new Date());
            if(localStorage.getItem('l-d') !== t) {
                habits.forEach(h=>h.done=false);
                localStorage.setItem('l-d', t);
                save();
            }
        }
        function resetDay() { 
            if(confirm("This will uncheck all boxes for today. Continue?")) { 
                habits.forEach(h=>h.done=false); 
                save(); 
                render();
            } 
        }

        window.addEventListener('keydown', (e) => {
            const f = document.querySelectorAll('.card, .btn, .day-cell, .nav-arrow');
            let i = Array.from(f).indexOf(document.activeElement);
            if(e.key==='ArrowRight'||e.key==='ArrowDown') i=(i+1)%f.length;
            if(e.key==='ArrowLeft'||e.key==='ArrowUp') i=(i-1+f.length)%f.length;
            if(f[i]) f[i].focus();
        });
    </script>
</body>
</html>
