<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toshkhana</title>
    <style>
        :root {
            --bg: #050505; --surface: #111; --accent: #00f2ff;
            --success: #00ff88; --text: #fff; --text-dim: #666; --danger: #ff4444;
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: 'Inter', system-ui, sans-serif; margin: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-x: hidden;
        }

        /* --- PULSE BAR (QUOTES) --- */
        #pulse-bar {
            width: 100%; background: #000; padding: 10px 0;
            border-bottom: 1px solid #222; display: flex;
            justify-content: center;
            font-size: 0.75rem;
            text-transform: uppercase; letter-spacing: 2px; color: var(--accent);
            text-align: center;
        }

        /* --- LOCK SCREEN --- */
        #lock-screen {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; justify-content: center; align-items: center; z-index: 10000;
        }
        #pin-input {
            background: #000; border: 2px solid var(--accent); color: var(--accent);
            font-size: 3rem; width: 180px; text-align: center; border-radius: 12px;
            outline: none;
        }
        #pin-input:focus { box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); }

        /* --- MAIN UI --- */
        #main-ui { display: none; width: 100%; max-width: 700px; padding: 30px; flex-direction: column; }
        
        /* HEADER */
        .header-flex { display: flex; justify-content: center; align-items: flex-end; margin-bottom: 30px; }
        .date-nav { display: flex; align-items: center; gap: 15px; }
        .nav-arrow {
            background: transparent; border: 1px solid #333; color: var(--text-dim);
            font-size: 1.2rem; cursor: pointer; padding: 8px 12px; border-radius: 6px;
            transition: all 0.2s; user-select: none;
        }
        .nav-arrow:hover { background: var(--accent); color: #000; border-color: var(--accent); }
        
        .date-wrapper { text-align: center; min-width: 200px; }
        #date-header { font-size: 3rem; font-weight: 800; margin: 0; letter-spacing: -2px; line-height: 1; }
        #day-header { color: var(--accent); margin:0; letter-spacing:2px; font-size: 1rem; font-weight: 500; }

        /* --- HABITS --- */
        .grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        
        .card {
            background: var(--surface); padding: 15px 20px; border-radius: 10px; border: 1px solid #222;
            cursor: pointer; transition: all 0.15s ease-out; display: flex; align-items: center; justify-content: space-between;
        }
        
        /* PC Tweak: Only show the ring on keyboard focus, not mouse click */
        .card:focus-visible { border-color: var(--accent); outline: none; background: #1a1a1a; transform: translateX(5px); }
        .card:hover { border-color: #444; background: #161616; transform: translateY(-2px); }
        
        .card.done { border-color: rgba(0, 255, 136, 0.3); background: rgba(0, 255, 136, 0.05); }
        .card.done:hover { border-color: var(--success); }
        .card.done .check { color: var(--success); text-shadow: 0 0 10px var(--success); }

        /* Main Screen Delete Button */
        .delete-btn {
            background: transparent; border: none; color: #333; font-size: 1.2rem;
            cursor: pointer; padding: 0 0 0 15px; line-height: 1; transition: 0.2s; opacity: 0;
        }
        .card:hover .delete-btn, .card:focus-visible .delete-btn { opacity: 1; }
        .delete-btn:hover { color: var(--danger); transform: scale(1.2); }

        /* --- MODAL --- */
        #modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 5000;
        }
        .modal-content {
            background: #0a0a0a; 
            width: 90vw; max-width: 900px; 
            padding: 30px; border-radius: 16px;
            display: flex; gap: 20px; border: 1px solid #333; 
            height: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            box-sizing: border-box; overflow: hidden;
        }
        
        .calendar-section { flex: 2; display: flex; flex-direction: column; min-width: 0; }
        #cal-month-header { margin: 0 0 15px 0; color: var(--accent); font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; }

        .calendar-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; 
            overflow-y: auto; padding-right: 5px;
        }
        .day-cell { 
            aspect-ratio: 1; background: #111; border-radius: 4px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.9rem; cursor: pointer; border: 1px solid #222; 
            transition: 0.1s;
        }
        .day-cell.perfect { background: var(--success) !important; color: #000; font-weight: bold; }
        .day-cell.today { border: 2px solid #fff; box-shadow: 0 0 15px rgba(255,255,255,0.15); z-index: 2; }
        .day-cell:hover, .day-cell.selected { border-color: var(--accent); background: #222; transform: scale(1.05); }
        
        .details-pane { 
            flex: 1; background: #050505; padding: 20px; border-radius: 8px; border: 1px solid #222;
            display: flex; flex-direction: column; min-width: 250px;
        }
        
        /* History List Styles */
        #det-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; }
        .hist-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 0; border-bottom: 1px solid #222; font-size: 0.9rem; 
        }
        .hist-del-btn {
            background: none; border: none; color: #444; cursor: pointer; font-size: 1.2rem; opacity: 0.5;
        }
        .hist-del-btn:hover { color: var(--danger); opacity: 1; }

        .btn {
            background: #151515; color: #ccc; padding: 10px 20px; border-radius: 6px;
            border: 1px solid #333; cursor: pointer; font-weight: 600; font-size: 0.85rem;
            transition: 0.2s;
        }
        .btn:hover { background: #222; color: #fff; border-color: #555; }
        .btn:focus-visible { border-color: var(--accent); color: #fff; outline: none; }
        
        .controls { display:flex; gap:12px; justify-content: center; margin-top: 30px;}
    </style>
</head>
<body>

    <div id="pulse-bar">
        <span id="daily-quote"></span>
    </div>

    <div id="lock-screen">
        <input type="password" id="pin-input" maxlength="4" placeholder="PIN" autofocus>
    </div>

    <div id="main-ui">
        <div class="header-flex">
            <div class="date-nav">
                <button class="nav-arrow" onclick="changeDate(-1)">&#9664;</button>
                <div class="date-wrapper">
                    <p id="day-header"></p>
                    <h1 id="date-header"></h1>
                </div>
                <button class="nav-arrow" onclick="changeDate(1)">&#9654;</button>
            </div>
        </div>

        <div class="grid" id="habit-grid"></div>

        <div class="controls">
            <button class="btn" onclick="toggleModal(true)">MONTHLY OVERVIEW</button>
            <button class="btn" onclick="addHabit()">+ HABIT</button>
            <button class="btn" onclick="resetDay()">RESET PROGRESS</button>
        </div>
    </div>

    <div id="modal" onclick="toggleModal(false)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="calendar-section">
                <h2 id="cal-month-header"></h2>
                <div class="calendar-grid" id="calendar"></div>
            </div>
            <div class="details-pane">
                <h3 id="det-date" style="color: var(--accent); margin-top:0;">Select Day</h3>
                <ul id="det-list"></ul>
            </div>
        </div>
    </div>

    <script>
        const PIN = "8472";
        
        const QUOTES = [
            "We are what we repeatedly do. Excellence, then, is not an act, but a habit.",
            "The pain of discipline or the pain of regret"
        ];
        
        let habits = JSON.parse(localStorage.getItem('h-v5')) || [];
        let history = JSON.parse(localStorage.getItem('hist-v5')) || {};
        let viewOffset = 0; 
        let selectedHistoryDate = null; 

        document.getElementById('pin-input').addEventListener('input', (e) => {
            if(e.target.value === PIN) {
                document.getElementById('lock-screen').style.display='none';
                document.getElementById('main-ui').style.display='flex';
                init();
            }
        });

        function init() {
            updateQuote();
            checkDayReset();
            render();
        }

        function updateQuote() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);
            const quoteIndex = dayOfYear % QUOTES.length;
            document.getElementById('daily-quote').innerText = QUOTES[quoteIndex].toUpperCase();
        }

        function getViewDate() {
            const d = new Date();
            d.setDate(d.getDate() + viewOffset);
            return d;
        }
        
        function getDateString(dateObj) {
            const offset = dateObj.getTimezoneOffset() * 60000;
            return (new Date(dateObj - offset)).toISOString().split('T')[0];
        }

        function changeDate(dir) {
            viewOffset += dir;
            render();
        }

        function render() {
            const grid = document.getElementById('habit-grid');
            grid.innerHTML = '';
            
            const viewDate = getViewDate();
            const viewDateStr = getDateString(viewDate);
            const isToday = viewOffset === 0;

            document.getElementById('date-header').innerText = viewDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            document.getElementById('day-header').innerText = viewDate.toLocaleDateString(undefined, { weekday: 'long' }) + (viewOffset === 0 ? " (Today)" : "");

            habits.forEach((h, index) => {
                let isDone = false;
                if (isToday) {
                    isDone = h.done;
                } else {
                    const record = history[viewDateStr];
                    if (record && record.items.includes(h.name)) isDone = true;
                }

                const card = document.createElement('div');
                card.className = `card ${isDone ? 'done' : ''}`;
                card.tabIndex = 0;
                
                card.innerHTML = `
                    <div style="flex-grow:1; font-weight:500;">${h.name}</div>
                    <div style="display:flex; align-items:center;">
                        <div class="check">${isDone ? '✦' : '✧'}</div>
                    </div>
                `;

                const delBtn = document.createElement('button');
                delBtn.innerHTML = '&times;';
                delBtn.className = 'delete-btn';
                delBtn.title = "Delete Habit";
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteHabit(index);
                };

                card.querySelector('div:last-child').appendChild(delBtn);

                card.onclick = () => toggleHabit(index, h.name, viewDateStr);
                card.onkeydown = (e) => { if(e.key === 'Enter') toggleHabit(index, h.name, viewDateStr); };
                
                grid.appendChild(card);
            });
        }

        function toggleHabit(index, name, dateStr) {
            const isToday = (dateStr === getDateString(new Date()));

            if (isToday) {
                habits[index].done = !habits[index].done;
                localStorage.setItem('h-v5', JSON.stringify(habits));
            }

            if (!history[dateStr]) history[dateStr] = { score: 0, items: [] };
            
            const histItems = history[dateStr].items;
            const itemIndex = histItems.indexOf(name);

            if (itemIndex > -1) histItems.splice(itemIndex, 1);
            else histItems.push(name);

            // Update score
            history[dateStr].score = habits.length ? histItems.length / habits.length : 0;
            localStorage.setItem('hist-v5', JSON.stringify(history));

            render();
        }

        function deleteHabit(index) {
            if(confirm("Are you sure you want to permanently delete this habit from your main list?")) {
                habits.splice(index, 1);
                save();
                render();
            }
        }

        function save() {
            localStorage.setItem('h-v5', JSON.stringify(habits));
            const todayStr = getDateString(new Date());
            history[todayStr] = { 
                score: habits.length ? habits.filter(x=>x.done).length / habits.length : 0,
                items: habits.filter(x=>x.done).map(x=>x.name)
            };
            localStorage.setItem('hist-v5', JSON.stringify(history));
        }

        function toggleModal(s) {
            document.getElementById('modal').style.display = s ? 'flex' : 'none';
            if(s) {
                const now = new Date();
                const todayStr = getDateString(now);
                selectedHistoryDate = todayStr;
                renderCalendar();
                showHistoryDetails(todayStr, now.getDate());
            }
        }

        function renderCalendar() {
            const cal = document.getElementById('calendar'); cal.innerHTML = '';
            const now = new Date();
            
            // Set Month Header
            document.getElementById('cal-month-header').innerText = now.toLocaleDateString(undefined, {month: 'long', year: 'numeric'});

            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const currentDay = now.getDate();
            
            for(let d=1; d<=daysInMonth; d++) {
                const ds = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                const data = history[ds];
                const cell = document.createElement('div');
                let classes = 'day-cell';
                
                if (data?.score >= 1) classes += ' perfect';
                if (d === currentDay) classes += ' today';
                if (selectedHistoryDate === ds) classes += ' selected';
                
                cell.className = classes;
                cell.innerText = d;
                
                cell.onclick = () => showHistoryDetails(ds, d);
                
                cal.appendChild(cell);
            }
        }

        function showHistoryDetails(dateStr, dayNum) {
            selectedHistoryDate = dateStr;
            renderCalendar();
            
            const data = history[dateStr];
            document.getElementById('det-date').innerText = `Details for Day ${dayNum}`;
            const list = document.getElementById('det-list');
            list.innerHTML = '';

            if (data && data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'hist-item';
                    li.innerHTML = `
                        <span>${item}</span>
                        <button class="hist-del-btn" onclick="removeHistoryItem('${dateStr}', '${item}')">&times;</button>
                    `;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = '<div style="color:#666; font-style:italic;">No habits recorded.</div>';
            }
        }

        function removeHistoryItem(dateStr, itemName) {
            if(!confirm(`Remove "${itemName}" from history for this date?`)) return;

            const rec = history[dateStr];
            if(rec) {
                rec.items = rec.items.filter(x => x !== itemName);
                rec.score = habits.length > 0 ? rec.items.length / habits.length : 0;
                localStorage.setItem('hist-v5', JSON.stringify(history));
                
                showHistoryDetails(dateStr, parseInt(dateStr.split('-')[2]));
                renderCalendar();
                render(); 
            }
        }

        function addHabit() { 
            const n = prompt("New Habit:"); 
            if(n) { habits.push({name:n, done:false}); save(); render(); } 
        }
        
        function checkDayReset() {
            const t = getDateString(new Date());
            if(localStorage.getItem('l-d') !== t) {
                habits.forEach(h=>h.done=false);
                localStorage.setItem('l-d', t);
                save();
            }
        }
        function resetDay() { 
            if(confirm("This will uncheck all boxes for today. Continue?")) { 
                habits.forEach(h=>h.done=false); 
                save(); 
                render();
            } 
        }

        // Keep arrow key navigation for power users (PC keyboard), 
        // but now it relies on focus-visible so mouse clicks don't trigger it visually.
        window.addEventListener('keydown', (e) => {
            const f = document.querySelectorAll('.card, .btn, .day-cell, .nav-arrow');
            let i = Array.from(f).indexOf(document.activeElement);
            if(e.key==='ArrowRight'||e.key==='ArrowDown') i=(i+1)%f.length;
            if(e.key==='ArrowLeft'||e.key==='ArrowUp') i=(i-1+f.length)%f.length;
            if(f[i]) f[i].focus();
        });
    </script>
</body>
</html>
