<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toshkhana</title>
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            /* Default (Dark Mode) */
            --bg: #050505; 
            --surface: #111; 
            --accent: #00f2ff;
            --success: #00ff88; 
            --text: #fff; 
            --text-dim: #666; 
            --danger: #ff4444;
            --border: #222;
            --card-hover: #161616;
            --modal-bg: #0a0a0a;
            
            /* Dynamic Glows */
            --today-glow: rgba(0, 242, 255, 0.4);
            --selected-border: #fff;
            --selected-glow: rgba(255,255,255,0.3);
            --selected-bg: #222;
        }

        /* Light Mode Overrides */
        [data-theme="light"] {
            --bg: #f0f2f5; 
            --surface: #ffffff; 
            --accent: #0077ff; 
            --success: #00cc6a; 
            --text: #1a1a1a; 
            --text-dim: #888; 
            --danger: #dc3545;
            --border: #d1d9e6;
            --card-hover: #f8f9fa;
            --modal-bg: #ffffff;
            
            --today-glow: rgba(0, 119, 255, 0.3);
            --selected-border: #000;
            --selected-glow: rgba(0,0,0,0.2);
            --selected-bg: #e9ecef;
        }

        body {
            background: var(--bg); color: var(--text);
            font-family: 'Inter', system-ui, sans-serif; margin: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- SETTINGS ICON --- */
        #settings-btn {
            position: fixed; top: 10px; right: 15px;
            background: transparent; border: none; color: var(--text-dim);
            cursor: pointer; z-index: 2000; padding: 5px;
            transition: transform 0.3s, color 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        #settings-btn:hover { transform: rotate(90deg); color: var(--accent); }
        #settings-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* --- PULSE BAR --- */
        #pulse-bar {
            width: 100%; background: var(--surface); padding: 15px 0;
            border-bottom: 1px solid var(--border); display: flex;
            justify-content: center;
            font-size: 0.8rem;
            text-transform: uppercase; letter-spacing: 2px; color: var(--accent);
            text-align: center;
            transition: background 0.3s;
            position: relative; z-index: 1000;
        }

        /* --- LOCK SCREEN --- */
        #lock-screen {
            position: fixed; inset: 0; background: var(--bg);
            display: flex; justify-content: center; align-items: center; z-index: 10000;
            transition: background 0.3s;
        }
        #pin-input {
            background: var(--surface); border: 2px solid var(--accent); color: var(--accent);
            font-size: 3rem; width: 180px; text-align: center; border-radius: 12px;
            outline: none; transition: background 0.3s;
        }
        #pin-input:focus { box-shadow: 0 0 20px var(--today-glow); }

        /* --- MAIN UI --- */
        #main-ui { display: none; width: 95%; max-width: 800px; padding: 30px; flex-direction: column; }
        
        .header-flex { display: flex; justify-content: center; align-items: flex-end; margin-bottom: 40px; }
        .date-nav { display: flex; align-items: center; gap: 20px; }
        .nav-arrow {
            background: transparent; border: 1px solid var(--border); color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer; padding: 10px 15px; border-radius: 8px;
            transition: all 0.2s; user-select: none;
        }
        .nav-arrow:hover { background: var(--accent); color: var(--bg); border-color: var(--accent); }
        
        .date-wrapper { text-align: center; min-width: 200px; }
        #date-header { font-size: 4rem; font-weight: 900; margin: 0; letter-spacing: -3px; line-height: 1; }
        #day-header { color: var(--accent); margin:0; letter-spacing:3px; font-size: 1.2rem; font-weight: 500; }

        /* --- HABITS --- */
        .grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        
        .card {
            background: var(--surface); padding: 20px 25px;
            border-radius: 15px; border: 1px solid var(--border);
            cursor: pointer; transition: all 0.15s ease-out; display: flex; align-items: center; justify-content: space-between;
            font-size: 1.1rem;
        }
        .card:focus-visible { border-color: var(--accent); outline: none; background: var(--card-hover); transform: translateX(5px); }
        .card:hover { border-color: var(--text-dim); background: var(--card-hover); transform: translateY(-3px); }
        
        .card.done { border-color: var(--success); background: rgba(0, 255, 136, 0.05); }
        [data-theme="light"] .card.done { background: rgba(0, 204, 106, 0.1); } 
        
        .card.done:hover { border-color: var(--success); }
        .card.done .check { color: var(--success); text-shadow: 0 0 10px var(--success); }

        .delete-btn {
            background: transparent; border: none; color: var(--text); font-size: 1.5rem;
            cursor: pointer; padding: 0 0 0 15px; line-height: 1; transition: 0.2s; opacity: 0;
        }
        .card:hover .delete-btn, .card:focus-visible .delete-btn { opacity: 1; }
        .delete-btn:hover { color: var(--danger); transform: scale(1.2); }

        /* --- GENERAL MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 5000;
        }
        [data-theme="light"] .modal-overlay { background: rgba(255,255,255,0.85); }

        .modal-content {
            background: var(--modal-bg); 
            border-radius: 20px;
            border: 1px solid var(--border); 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            box-sizing: border-box; overflow: hidden;
            transition: background 0.3s;
        }

        /* --- MONTHLY OVERVIEW SPECIFIC --- */
        #calendar-modal-content {
            width: 95vw; max-width: 1300px; height: 90vh;
            padding: 40px; display: flex; gap: 40px; 
        }

        /* --- TRACKER MODAL SPECIFIC --- */
        #tracker-modal-content {
            width: 90vw; max-width: 800px; max-height: 80vh;
            padding: 40px; display: flex; flex-direction: column;
        }

        /* Calendar Styles */
        .calendar-section { flex: 3; display: flex; flex-direction: column; min-width: 0; }
        .month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        #cal-month-header { margin: 0; color: var(--accent); font-size: 1.8rem; text-transform: uppercase; letter-spacing: 2px; }
        .month-arrow {
            background: transparent; border: none; color: var(--text-dim); font-size: 1.5rem; cursor: pointer;
            padding: 5px 15px; transition: 0.2s;
        }
        .month-arrow:hover { color: var(--accent); transform: scale(1.2); }
        .weekdays-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;
            padding: 0 20px; text-align: center; 
            font-weight: bold; color: var(--text-dim); margin-bottom: 10px;
        }
        .calendar-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: 1fr; 
            gap: 10px; flex-grow: 1; overflow: hidden; padding: 20px; 
        }
        .day-cell { 
            background: var(--surface); border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 1.4rem; cursor: pointer; border: 1px solid var(--border); 
            transition: 0.1s; position: relative; 
        }
        .day-cell.perfect { background: var(--success) !important; color: #000; font-weight: bold; }
        .day-cell.today { 
            border: 2px solid var(--accent); box-shadow: 0 0 15px var(--today-glow);
            z-index: 2; color: var(--accent); font-weight: bold;
        }
        .day-cell:hover { border-color: var(--accent); background: var(--card-hover); transform: scale(1.05); z-index: 3; }
        .day-cell.selected { 
            border-color: var(--selected-border); box-shadow: 0 0 10px var(--selected-glow);
            background: var(--selected-bg); transform: scale(1.05); z-index: 4; color: var(--text); font-weight: bold;
        }
        
        /* NOTE INDICATOR DOT */
        .day-cell.has-note::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 6px;
            height: 6px;
            background-color: var(--accent);
            border-radius: 50%;
            box-shadow: 0 0 5px var(--accent);
        }

        .details-pane { 
            flex: 1; background: var(--bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border);
            display: flex; flex-direction: column; min-width: 320px; transition: background 0.3s;
        }

        .info-label { color: var(--text-dim); font-size: 0.8rem; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; }
        
        #day-note {
            width: 100%; flex-grow: 1;
            background: var(--surface); border: 1px solid var(--border);
            color: var(--text); font-family: 'Inter', sans-serif; font-size: 1rem;
            padding: 15px; border-radius: 8px; resize: none; margin-bottom: 15px;
            outline: none; box-sizing: border-box; transition: border 0.3s;
        }
        #day-note:focus { border-color: var(--accent); }
        
        #det-list { list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; border-top: 1px solid var(--border); }
        .hist-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; color: var(--text-dim);
        }
        .hist-del-btn {
            background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 1.1rem; opacity: 0.5;
        }
        .hist-del-btn:hover { color: var(--danger); opacity: 1; }

        /* --- TRACKER STYLES --- */
        #tracker-header { margin: 0 0 30px 0; color: var(--accent); text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        .tracker-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;
            overflow-y: auto; padding: 10px;
        }
        .stat-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-5px); border-color: var(--accent); }
        .stat-icon { width: 48px; height: 48px; margin-bottom: 10px; fill: var(--text-dim); }
        
        /* Rank Colors */
        .rank-novice { fill: #888; }
        .rank-apprentice { fill: var(--success); }
        .rank-adept { fill: #00f2ff; }
        .rank-expert { fill: #bd00ff; }
        .rank-master { fill: #ffcc00; filter: drop-shadow(0 0 5px #ffcc00); }

        .stat-name { font-weight: bold; margin-bottom: 5px; font-size: 1.1rem; }
        .stat-count { font-size: 2rem; font-weight: 900; line-height: 1; color: var(--text); }
        .stat-label { font-size: 0.8rem; color: var(--text-dim); text-transform: uppercase; margin-top: 5px; }

        .btn {
            background: var(--surface); color: var(--text-dim); padding: 12px 24px; border-radius: 8px;
            border: 1px solid var(--border); cursor: pointer; font-weight: 600; font-size: 1rem;
            transition: 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: var(--card-hover); color: var(--text); border-color: var(--text-dim); }
        .btn:focus-visible { border-color: var(--accent); color: var(--text); outline: none; }
        
        .controls { display:flex; gap:15px; justify-content: center; margin-top: 40px;}
    </style>
</head>
<body>

    <button id="settings-btn" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
        <svg viewBox="0 0 24 24">
            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
        </svg>
    </button>

    <div id="pulse-bar">
        <span id="daily-quote"></span>
    </div>

    <div id="lock-screen">
        <input type="password" id="pin-input" maxlength="4" placeholder="PIN" autofocus>
    </div>

    <div id="main-ui">
        <div class="header-flex">
            <div class="date-nav">
                <button class="nav-arrow" onclick="changeDate(-1)">&#9664;</button>
                <div class="date-wrapper">
                    <p id="day-header"></p>
                    <h1 id="date-header"></h1>
                </div>
                <button class="nav-arrow" onclick="changeDate(1)">&#9654;</button>
            </div>
        </div>

        <div class="grid" id="habit-grid"></div>

        <div class="controls">
            <button class="btn" onclick="openCalendar()">ðŸ“… MONTHLY OVERVIEW</button>
            <button class="btn" onclick="addHabit()">+ HABIT</button>
            <button class="btn" onclick="openTracker()">ðŸ“Š TRACKER</button>
        </div>
    </div>

    <div id="calendar-modal" class="modal-overlay" onclick="closeModals()">
        <div class="modal-content" id="calendar-modal-content" onclick="event.stopPropagation()">
            <div class="calendar-section">
                <div class="month-nav">
                    <button class="month-arrow" onclick="changeMonth(-1)">&#9664;</button>
                    <h2 id="cal-month-header"></h2>
                    <button class="month-arrow" onclick="changeMonth(1)">&#9654;</button>
                </div>
                <div class="weekdays-grid">
                    <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                </div>
                <div class="calendar-grid" id="calendar"></div>
            </div>
            <div class="details-pane">
                <h3 id="det-date" style="color: var(--accent); margin-top:0;">Select Day</h3>
                <textarea id="day-note" placeholder="Add daily information..."></textarea>
                <div class="info-label">Completed Habits</div>
                <ul id="det-list"></ul>
            </div>
        </div>
    </div>

    <div id="tracker-modal" class="modal-overlay" onclick="closeModals()">
        <div class="modal-content" id="tracker-modal-content" onclick="event.stopPropagation()">
            <h2 id="tracker-header">Lifetime Stats</h2>
            <div class="tracker-grid" id="tracker-grid"></div>
        </div>
    </div>

    <script>
        const PIN = "8472";
        
        const QUOTES = [
            "We are what we repeatedly do. Excellence, then, is not an act, but a habit.",
            "The pain of discipline or the pain of regret"
        ];
        
        let habits = JSON.parse(localStorage.getItem('h-v5')) || [];
        let history = JSON.parse(localStorage.getItem('hist-v5')) || {};
        let viewOffset = 0; 
        let calendarOffset = 0; 
        let selectedHistoryDate = null; 

        // --- SOUND EFFECT ---
        function playSuccessSound() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const now = ctx.currentTime;
            const notes = [
                { freq: 392.00, start: 0.0, dur: 0.1 }, 
                { freq: 523.25, start: 0.1, dur: 0.1 }, 
                { freq: 659.25, start: 0.2, dur: 0.1 }, 
                { freq: 1046.50, start: 0.3, dur: 0.4 } 
            ];
            notes.forEach(n => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'triangle'; 
                osc.frequency.value = n.freq;
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(now + n.start);
                gain.gain.setValueAtTime(0.1, now + n.start);
                gain.gain.exponentialRampToValueAtTime(0.001, now + n.start + n.dur);
                osc.stop(now + n.start + n.dur);
            });
        }

        // --- THEME ---
        function initTheme() {
            if(localStorage.getItem('theme') === 'light') document.documentElement.setAttribute('data-theme', 'light');
        }
        function toggleTheme() {
            if(document.documentElement.getAttribute('data-theme') === 'light') {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        }
        initTheme();

        document.getElementById('pin-input').addEventListener('input', (e) => {
            if(e.target.value === PIN) {
                document.getElementById('lock-screen').style.display='none';
                document.getElementById('main-ui').style.display='flex';
                init();
            }
        });

        document.getElementById('day-note').addEventListener('input', (e) => {
            if (selectedHistoryDate) {
                if (!history[selectedHistoryDate]) history[selectedHistoryDate] = { score: 0, items: [], note: "" };
                history[selectedHistoryDate].note = e.target.value;
                localStorage.setItem('hist-v5', JSON.stringify(history));
                
                // VISUAL UPDATE: Show Dot instantly on current cell
                const cell = document.querySelector('.day-cell.selected');
                if(cell) {
                    if(e.target.value.trim() !== "") cell.classList.add('has-note');
                    else cell.classList.remove('has-note');
                }
            }
        });

        function init() {
            updateQuote();
            checkDayReset();
            render();
        }

        function updateQuote() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);
            const quoteIndex = dayOfYear % QUOTES.length;
            document.getElementById('daily-quote').innerText = QUOTES[quoteIndex].toUpperCase();
        }

        function getViewDate() {
            const d = new Date();
            d.setDate(d.getDate() + viewOffset);
            return d;
        }
        
        function getDateString(dateObj) {
            const offset = dateObj.getTimezoneOffset() * 60000;
            return (new Date(dateObj - offset)).toISOString().split('T')[0];
        }

        function changeDate(dir) {
            viewOffset += dir;
            render();
        }

        function render() {
            const grid = document.getElementById('habit-grid');
            grid.innerHTML = '';
            
            const viewDate = getViewDate();
            const viewDateStr = getDateString(viewDate);
            const isToday = viewOffset === 0;

            document.getElementById('date-header').innerText = viewDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
            document.getElementById('day-header').innerText = viewDate.toLocaleDateString(undefined, { weekday: 'long' }) + (viewOffset === 0 ? " (Today)" : "");

            habits.forEach((h, index) => {
                let isDone = false;
                if (isToday) {
                    isDone = h.done;
                } else {
                    const record = history[viewDateStr];
                    if (record && record.items.includes(h.name)) isDone = true;
                }

                const card = document.createElement('div');
                card.className = `card ${isDone ? 'done' : ''}`;
                card.tabIndex = 0;
                
                card.innerHTML = `
                    <div style="flex-grow:1; font-weight:500;">${h.name}</div>
                    <div style="display:flex; align-items:center;">
                        <div class="check">${isDone ? 'âœ¦' : 'âœ§'}</div>
                    </div>
                `;

                const delBtn = document.createElement('button');
                delBtn.innerHTML = '&times;';
                delBtn.className = 'delete-btn';
                delBtn.title = "Delete Habit";
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteHabit(index);
                };

                card.querySelector('div:last-child').appendChild(delBtn);

                card.onclick = () => toggleHabit(index, h.name, viewDateStr);
                card.onkeydown = (e) => { if(e.key === 'Enter') toggleHabit(index, h.name, viewDateStr); };
                
                grid.appendChild(card);
            });
        }

        function toggleHabit(index, name, dateStr) {
            const isToday = (dateStr === getDateString(new Date()));

            if (isToday) {
                habits[index].done = !habits[index].done;
                if(habits[index].done) playSuccessSound();
                localStorage.setItem('h-v5', JSON.stringify(habits));
            }

            if (!history[dateStr]) history[dateStr] = { score: 0, items: [], note: "" };
            
            const histItems = history[dateStr].items;
            const itemIndex = histItems.indexOf(name);

            if (itemIndex > -1) histItems.splice(itemIndex, 1);
            else histItems.push(name);

            history[dateStr].score = habits.length ? histItems.length / habits.length : 0;
            localStorage.setItem('hist-v5', JSON.stringify(history));

            render();
        }

        function deleteHabit(index) {
            if(confirm("Are you sure you want to permanently delete this habit from your main list?")) {
                habits.splice(index, 1);
                save();
                render();
            }
        }

        function save() {
            localStorage.setItem('h-v5', JSON.stringify(habits));
            const todayStr = getDateString(new Date());
            const existingNote = history[todayStr] ? history[todayStr].note : "";
            history[todayStr] = { 
                score: habits.length ? habits.filter(x=>x.done).length / habits.length : 0,
                items: habits.filter(x=>x.done).map(x=>x.name),
                note: existingNote
            };
            localStorage.setItem('hist-v5', JSON.stringify(history));
        }

        // --- MODAL HANDLING ---
        function closeModals() {
            document.getElementById('calendar-modal').style.display = 'none';
            document.getElementById('tracker-modal').style.display = 'none';
        }

        function openCalendar() {
            closeModals();
            document.getElementById('calendar-modal').style.display = 'flex';
            calendarOffset = 0; 
            const now = new Date();
            const todayStr = getDateString(now);
            selectedHistoryDate = todayStr;
            renderCalendar();
            showHistoryDetails(todayStr, now.getDate());
        }

        function changeMonth(dir) {
            calendarOffset += dir;
            renderCalendar();
        }

        function renderCalendar() {
            const cal = document.getElementById('calendar'); cal.innerHTML = '';
            
            const now = new Date();
            now.setDate(1); 
            now.setMonth(now.getMonth() + calendarOffset);
            
            document.getElementById('cal-month-header').innerText = now.toLocaleDateString(undefined, {month: 'long', year: 'numeric'});

            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const realNow = new Date();
            const isCurrentMonth = (now.getMonth() === realNow.getMonth() && now.getFullYear() === realNow.getFullYear());
            const currentDay = realNow.getDate();
            const firstDayIndex = new Date(now.getFullYear(), now.getMonth(), 1).getDay();

            for(let i=0; i<firstDayIndex; i++) {
                const empty = document.createElement('div');
                cal.appendChild(empty);
            }
            
            for(let d=1; d<=daysInMonth; d++) {
                const ds = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                
                const data = history[ds];
                const cell = document.createElement('div');
                let classes = 'day-cell';
                
                if (data?.score >= 1) classes += ' perfect';
                if (isCurrentMonth && d === currentDay) classes += ' today';
                if (selectedHistoryDate === ds) classes += ' selected';
                
                // INDICATOR CHECK
                if (data?.note && data.note.trim() !== "") classes += ' has-note';
                
                cell.className = classes;
                cell.innerText = d;
                
                cell.onclick = () => showHistoryDetails(ds, d);
                
                cal.appendChild(cell);
            }
        }

        function showHistoryDetails(dateStr, dayNum) {
            selectedHistoryDate = dateStr;
            renderCalendar();
            
            const data = history[dateStr];
            document.getElementById('det-date').innerText = `Details for Day ${dayNum}`;
            const list = document.getElementById('det-list');
            const noteInput = document.getElementById('day-note');
            
            list.innerHTML = '';
            noteInput.value = (data && data.note) ? data.note : "";

            if (data && data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'hist-item';
                    li.innerHTML = `<span>${item}</span><button class="hist-del-btn" onclick="removeHistoryItem('${dateStr}', '${item}')">&times;</button>`;
                    list.appendChild(li);
                });
            } else {
                list.innerHTML = '<div style="color:var(--text-dim); font-style:italic; font-size:0.8rem; padding:10px 0;">No habits recorded.</div>';
            }
        }

        function removeHistoryItem(dateStr, itemName) {
            if(!confirm(`Remove "${itemName}" from history for this date?`)) return;
            const rec = history[dateStr];
            if(rec) {
                rec.items = rec.items.filter(x => x !== itemName);
                rec.score = habits.length > 0 ? rec.items.length / habits.length : 0;
                localStorage.setItem('hist-v5', JSON.stringify(history));
                showHistoryDetails(dateStr, parseInt(dateStr.split('-')[2]));
                renderCalendar();
                render(); 
            }
        }

        // --- TRACKER LOGIC ---
        function openTracker() {
            closeModals();
            document.getElementById('tracker-modal').style.display = 'flex';
            
            const stats = {};
            habits.forEach(h => stats[h.name] = 0); // Init active habits

            // Aggregate counts
            Object.values(history).forEach(day => {
                if(day.items) {
                    day.items.forEach(hName => {
                        if(stats[hName] !== undefined) stats[hName]++;
                        else stats[hName] = 1; // Include deleted ones if desired
                    });
                }
            });

            const grid = document.getElementById('tracker-grid');
            grid.innerHTML = '';

            Object.entries(stats).forEach(([name, count]) => {
                let tierClass = 'rank-novice';
                let tierName = 'NOVICE';
                if(count >= 365) { tierClass = 'rank-master'; tierName = 'MASTER'; }
                else if(count >= 90) { tierClass = 'rank-expert'; tierName = 'EXPERT'; }
                else if(count >= 30) { tierClass = 'rank-adept'; tierName = 'ADEPT'; }
                else if(count >= 7) { tierClass = 'rank-apprentice'; tierName = 'APPRENTICE'; }

                const div = document.createElement('div');
                div.className = 'stat-card';
                div.innerHTML = `
                    <svg class="stat-icon ${tierClass}" viewBox="0 0 24 24">
                        <path d="M12,2L9,9H2L7,14L5,21L12,17L19,21L17,14L22,9H15L12,2Z"/>
                    </svg>
                    <div class="stat-name">${name}</div>
                    <div class="stat-count">${count}</div>
                    <div class="stat-label">Days Total</div>
                    <div class="stat-label" style="font-size:0.7rem; color:${tierClass === 'rank-master' ? '#ffcc00' : 'var(--accent)'}">${tierName}</div>
                `;
                grid.appendChild(div);
            });
        }

        function addHabit() { 
            const n = prompt("New Habit:"); 
            if(n) { habits.push({name:n, done:false}); save(); render(); } 
        }
        
        function checkDayReset() {
            const t = getDateString(new Date());
            if(localStorage.getItem('l-d') !== t) {
                habits.forEach(h=>h.done=false);
                localStorage.setItem('l-d', t);
                save();
            }
        }

        window.addEventListener('keydown', (e) => {
            const f = document.querySelectorAll('.card, .btn, .day-cell, .nav-arrow, #settings-btn');
            if (document.activeElement.tagName === 'TEXTAREA') return;
            
            let i = Array.from(f).indexOf(document.activeElement);
            if(e.key==='ArrowRight'||e.key==='ArrowDown') i=(i+1)%f.length;
            if(e.key==='ArrowLeft'||e.key==='ArrowUp') i=(i-1+f.length)%f.length;
            if(f[i]) f[i].focus();
        });
    </script>
</body>
</html>
